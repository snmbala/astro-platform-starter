---
import Layout from '../../layouts/Layout.astro';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths = (() => {
    const modules = import.meta.glob('/content/blog/*.md', { eager: true });

    return Object.entries(modules).map(([path, mod]: [string, any]) => {
        const slug = path.split('/').pop()?.replace('.md', '') || '';
        return {
            params: { slug },
            props: {
                post: mod,
                contentPath: path.replace('/content/', 'content/')
            }
        };
    });
}) satisfies GetStaticPaths;

const { post, contentPath } = Astro.props;
const { Content, frontmatter } = post;

// Check if post uses new content blocks or legacy markdown
const hasContentBlocks = frontmatter.content && Array.isArray(frontmatter.content);
---

<Layout title={frontmatter.title}>
    <article class="max-w-3xl mx-auto px-4 py-12" data-sb-object-id={contentPath}>
        {
            frontmatter.coverImage && (
                <div class="mb-8 -mx-4 sm:mx-0" data-sb-field-path="coverImage">
                    <img src={frontmatter.coverImage} alt={frontmatter.title} class="w-full h-64 sm:h-96 object-cover sm:rounded-lg shadow-lg" />
                </div>
            )
        }

        <header class="mb-8">
            <h1 class="text-4xl font-bold mb-4" data-sb-field-path="title">{frontmatter.title}</h1>

            <div class="text-gray-600 mb-4">
                <time datetime={frontmatter.publishDate} data-sb-field-path="publishDate">
                    {
                        new Date(frontmatter.publishDate).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        })
                    }
                </time>
                {frontmatter.author && <span data-sb-field-path="author"> • {frontmatter.author}</span>}
            </div>

            {
                frontmatter.tags && (
                    <div class="flex gap-2 mb-6" data-sb-field-path="tags">
                        {frontmatter.tags.map((tag: string) => (
                            <span class="text-sm bg-gray-200 px-3 py-1 rounded">{tag}</span>
                        ))}
                    </div>
                )
            }

            {
                frontmatter.description && (
                    <p class="text-xl text-gray-700 border-l-4 border-blue-500 pl-4 italic" data-sb-field-path="description">
                        {frontmatter.description}
                    </p>
                )
            }
        </header>

        {
            hasContentBlocks ? (
                <div class="content-blocks" data-sb-field-path="content">
                    {frontmatter.content.map((block: any, index: number) => {
                        if (block.type === 'heading') {
                            const Tag = block.level || 'h2';
                            return (
                                <Tag
                                    class={`font-bold mt-8 mb-4 ${block.level === 'h2' ? 'text-3xl' : block.level === 'h3' ? 'text-2xl' : 'text-xl'}`}
                                    data-sb-field-path={`.${index}.text`}
                                >
                                    {block.text}
                                </Tag>
                            );
                        } else if (block.type === 'text') {
                            return <div class="prose-block mb-4" data-sb-field-path={`.${index}.text`} set:html={block.text} />;
                        } else if (block.type === 'image') {
                            return (
                                <figure class="my-6" data-sb-field-path={`.${index}`}>
                                    <img src={block.url} alt={block.alt || ''} class="w-full rounded-lg shadow-md" data-sb-field-path={`.${index}.url`} />
                                    {block.caption && (
                                        <figcaption class="text-center text-sm text-gray-600 mt-2" data-sb-field-path={`.${index}.caption`}>
                                            {block.caption}
                                        </figcaption>
                                    )}
                                </figure>
                            );
                        } else if (block.type === 'quote') {
                            return (
                                <blockquote class="border-l-4 border-blue-500 pl-4 italic my-6 text-gray-700" data-sb-field-path={`.${index}`}>
                                    <p data-sb-field-path={`.${index}.text`}>{block.text}</p>
                                    {block.author && (
                                        <cite class="block mt-2 text-sm not-italic" data-sb-field-path={`.${index}.author`}>
                                            — {block.author}
                                        </cite>
                                    )}
                                </blockquote>
                            );
                        } else if (block.type === 'list') {
                            const ListTag = block.style === 'numbered' ? 'ol' : 'ul';
                            return (
                                <ListTag
                                    class={`mb-4 ${block.style === 'numbered' ? 'list-decimal' : 'list-disc'} pl-6`}
                                    data-sb-field-path={`.${index}.items`}
                                >
                                    {block.items?.map((item: string, i: number) => (
                                        <li class="mb-2" data-sb-field-path={`.${index}.items.${i}`}>
                                            {item}
                                        </li>
                                    ))}
                                </ListTag>
                            );
                        }
                    })}
                </div>
            ) : (
                <div class="prose prose-lg max-w-none" data-sb-field-path=".">
                    <Content />
                </div>
            )
        }

        <footer class="mt-12 pt-8 border-t border-gray-200">
            <a href="/blog" class="text-blue-600 hover:underline"> ← Back to all posts </a>
        </footer>
    </article>
</Layout>

<style>
    /* Enhanced prose styling for better readability */
    .prose,
    .prose-block {
        color: #1f2937;
        line-height: 1.75;
    }
    .content-blocks {
        color: #1f2937;
    }
    .prose-block p {
        margin-bottom: 1rem;
    }
    .prose-block strong {
        font-weight: 700;
        color: #111827;
    }
    .prose-block em {
        font-style: italic;
    }
    .prose-block a {
        color: #2563eb;
        text-decoration: none;
    }
    .prose-block a:hover {
        text-decoration: underline;
    }
    .prose h1 {
        font-size: 2.25rem;
        font-weight: 700;
        margin-top: 2rem;
        margin-bottom: 1.5rem;
    }
    .prose h2 {
        font-size: 1.875rem;
        font-weight: 700;
        margin-top: 2rem;
        margin-bottom: 1rem;
    }
    .prose h3 {
        font-size: 1.5rem;
        font-weight: 700;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
    }
    .prose p {
        margin-bottom: 1rem;
        line-height: 1.75;
    }
    .prose ul,
    .prose ol {
        margin-bottom: 1rem;
        padding-left: 1.5rem;
    }
    .prose li {
        margin-bottom: 0.5rem;
    }
    .prose img {
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin: 1.5rem 0;
        max-width: 100%;
        height: auto;
    }
    .prose strong {
        font-weight: 700;
        color: #111827;
    }
    .prose em {
        font-style: italic;
    }
    .prose code {
        background-color: #f3f4f6;
        padding: 0.125rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        font-family: monospace;
    }
    .prose pre {
        background-color: #111827;
        color: #f3f4f6;
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin: 1.5rem 0;
    }
    .prose a {
        color: #2563eb;
        text-decoration: none;
    }
    .prose a:hover {
        text-decoration: underline;
    }
    .prose blockquote {
        border-left: 4px solid #3b82f6;
        padding-left: 1rem;
        font-style: italic;
        margin: 1.5rem 0;
        color: #4b5563;
    }
</style>
