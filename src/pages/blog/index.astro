---
import Layout from '../../layouts/Layout.astro';

// Get all blog posts from the content directory using import.meta.glob
const modules = import.meta.glob('/content/blog/*.md', { eager: true });

// Convert modules to posts array
const posts = Object.entries(modules).map(([path, mod]: [string, any]) => ({
    ...mod,
    url: `/blog/${path.split('/').pop()?.replace('.md', '')}`,
    file: path
}));

// Sort posts by date (newest first)
const sortedPosts = posts
    .filter((post) => !post.frontmatter?.draft)
    .sort((a, b) => {
        const dateA = new Date(a.frontmatter?.publishDate || 0);
        const dateB = new Date(b.frontmatter?.publishDate || 0);
        return dateB.getTime() - dateA.getTime();
    });
---

<Layout title="Blog">
    <div class="max-w-4xl mx-auto px-4 py-12">
        <h1 class="text-4xl font-bold mb-8">Blog</h1>

        <div class="space-y-8">
            {
                sortedPosts.map((post) => (
                    <article class="border-b border-gray-200 pb-8" data-sb-object-id={post.file.replace('/content/', 'content/')}>
                        <h2 class="text-2xl font-bold mb-2">
                            <a href={post.url} class="hover:text-blue-600" data-sb-field-path="title">
                                {post.frontmatter.title}
                            </a>
                        </h2>

                        <div class="text-sm text-gray-600 mb-3">
                            <time datetime={post.frontmatter.publishDate} data-sb-field-path="publishDate">
                                {new Date(post.frontmatter.publishDate).toLocaleDateString('en-US', {
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric'
                                })}
                            </time>
                            {post.frontmatter.author && <span data-sb-field-path="author"> â€¢ {post.frontmatter.author}</span>}
                        </div>

                        {post.frontmatter.description && <p class="text-gray-700 mb-3" data-sb-field-path="description">{post.frontmatter.description}</p>}

                        {post.frontmatter.tags && (
                            <div class="flex gap-2" data-sb-field-path="tags">
                                {post.frontmatter.tags.map((tag: string) => (
                                    <span class="text-xs bg-gray-200 px-2 py-1 rounded">{tag}</span>
                                ))}
                            </div>
                        )}
                    </article>
                ))
            }

            {sortedPosts.length === 0 && <p class="text-gray-600">No blog posts yet. Create one in the content/blog directory!</p>}
        </div>
    </div>
</Layout>
